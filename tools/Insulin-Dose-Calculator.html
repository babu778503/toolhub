<!DOCTYPE html>
<!-- Category: Health -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Insulin Dose Calculator - Calculate your insulin dose with this easy-to-use health tool. Determine bolus insulin based on carbohydrates and current glucose levels.">
    <meta name="keywords" content="insulin dose calculator, bolus calculator, insulin calculator, diabetes management, insulin dose, carb counting, blood glucose, diabetes tool">
    <title>Insulin Dose Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Desktop Styles */
        header {
            background: linear-gradient(to right, #8e44ad, #9b59b6);
            color: white;
            padding: 0 20px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #8e44ad;
            border-bottom: 3px solid #8e44ad;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #8e44ad;
            box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(to right, #8e44ad, #9b59b6);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            flex: 1;
            min-width: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(142, 68, 173, 0.3);
        }

        .reset-btn {
            background: linear-gradient(to right, #3498db, #2c3e50);
        }

        .reset-btn:hover {
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .export-btn {
            background: linear-gradient(to right, #27ae60, #219653);
        }

        .export-btn:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
            border-top: 4px solid #8e44ad;
        }

        .result-card:hover {
            transform: translateY(-5px);
        }

        .result-card.carb-card {
            border-top-color: #f39c12;
        }

        .result-card.bg-card {
            border-top-color: #e74c3c;
        }

        .result-card.total-card {
            border-top-color: #27ae60;
        }

        .result-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-value {
            font-size: 28px;
            font-weight: 700;
            color: #8e44ad;
            margin: 10px 0;
        }

        .result-status {
            font-size: 16px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 8px;
        }

        .normal { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .caution { background-color: #ffeaa7; color: #856404; }
        .high { background-color: #f8d7da; color: #721c24; }
        .low { background-color: #cce5ff; color: #004085; }

        .interpretation {
            background: #f5eafa;
            border-left: 4px solid #8e44ad;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin: 25px 0;
            text-align: left;
        }

        .interpretation h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .interpretation ul {
            padding-left: 20px;
        }

        .interpretation li {
            margin-bottom: 10px;
            color: #6c3483;
        }

        .chart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 25px 0;
        }

        .chart-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .chart-bars {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 200px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .chart-bar {
            width: 60px;
            background: linear-gradient(to top, #8e44ad, #9b59b6);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: height 1s ease-in-out;
        }

        .chart-bar.carb-bar {
            background: linear-gradient(to top, #f39c12, #e67e22);
        }

        .chart-bar.bg-bar {
            background: linear-gradient(to top, #e74c3c, #c0392b);
        }

        .chart-label {
            text-align: center;
            margin-top: 10px;
            font-weight: 500;
            color: #2c3e50;
        }

        .chart-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: #2c3e50;
        }

        .data-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .data-actions button {
            flex: 1;
            min-width: 150px;
        }

        .clear-btn {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }

        .clear-btn:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .health-tip {
            background: linear-gradient(135deg, #f5eafa, #e8daef);
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            font-size: 15px;
            color: #2c3e50;
            border-left: 4px solid #8e44ad;
        }

        .health-tip h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }

        .history-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #8e44ad;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }

        .history-item-values {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .history-value {
            text-align: center;
            font-size: 14px;
        }

        .history-value-label {
            font-weight: 500;
            color: #777;
        }

        .history-value-data {
            font-weight: 600;
            color: #8e44ad;
        }

        .delete-history {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .no-history {
            text-align: center;
            color: #777;
            font-style: italic;
            padding: 20px;
        }

        .risk-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: #fff3cd;
        }

        .risk-icon {
            font-size: 24px;
            color: #856404;
        }

        .risk-text {
            font-weight: 500;
            color: #856404;
        }

        .recommendations {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            border-left: 4px solid #27ae60;
        }

        .recommendations h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .recommendation-list {
            padding-left: 20px;
        }

        .recommendation-list li {
            margin-bottom: 10px;
            color: #27663a;
        }

        .progress-tracker {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 25px 0;
        }

        .progress-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .progress-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .progress-chart {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .progress-chart h4 {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .progress-line {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #8e44ad, #9b59b6);
            border-radius: 15px;
            transition: width 1s ease-in-out;
        }

        .progress-target {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: #27ae60;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
            color: #6c757d;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                height: 50px;
                padding: 0 15px;
                margin-bottom: 20px;
                justify-content: center;
            }

            h1 {
                font-size: 18px;
                gap: 8px;
            }

            .tab-content {
                padding: 20px;
            }

            .input-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            input, select {
                padding: 12px;
                font-size: 16px;
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
            }

            button {
                padding: 12px 20px;
                font-size: 14px;
                min-width: auto;
            }

            .result-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .result-value {
                font-size: 24px;
            }

            .chart-bars {
                flex-direction: column;
                height: auto;
                gap: 20px;
                padding: 20px;
            }

            .chart-bar {
                width: 100%;
                height: 40px !important;
                border-radius: 0 5px 5px 0;
            }

            .chart-value {
                top: 50%;
                left: auto;
                right: -50px;
                transform: translateY(-50%);
            }

            .data-actions {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                padding: 20px 15px;
            }

            .history-item-values {
                grid-template-columns: 1fr 1fr;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                min-width: 50%;
            }

            .progress-charts {
                grid-template-columns: 1fr;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            transform: translateX(200%);
            transition: transform 0.3s ease-in-out;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(to right, #27ae60, #219653);
        }

        .notification.error {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }

        .notification.info {
            background: linear-gradient(to right, #3498db, #2c3e50);
        }

        .formula-explanation {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
            border-left: 4px solid #3498db;
        }

        .formula-explanation h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .formula-steps {
            padding-left: 20px;
        }

        .formula-steps li {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .formula-steps strong {
            color: #3498db;
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-syringe"></i> Insulin Dose Calculator</h1>
    </header>

    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="calculator">Calculator</div>
            <div class="tab" data-tab="history">History</div>
            <div class="tab" data-tab="progress">Progress</div>
            <div class="tab" data-tab="resources">Resources</div>
        </div>

        <div class="tab-content active" id="calculator-tab">
            <div class="input-grid">
                <div class="input-group">
                    <label for="carbs"><i class="fas fa-bread-slice"></i> Carbohydrates (grams)</label>
                    <input type="number" id="carbs" placeholder="Enter carbs consumed" min="0">
                </div>
                
                <div class="input-group">
                    <label for="current-bg"><i class="fas fa-heartbeat"></i> Current Glucose (mg/dL)</label>
                    <input type="number" id="current-bg" placeholder="Enter current glucose" min="0">
                </div>
                
                <div class="input-group">
                    <label for="target-bg"><i class="fas fa-bullseye"></i> Target Glucose (mg/dL)</label>
                    <input type="number" id="target-bg" placeholder="Enter target glucose" min="0" value="100">
                </div>
                
                <div class="input-group">
                    <label for="carb-ratio"><i class="fas fa-calculator"></i> Insulin-to-Carb Ratio (1:)</label>
                    <input type="number" id="carb-ratio" placeholder="Enter carb ratio" min="1" value="10">
                </div>
                
                <div class="input-group">
                    <label for="correction-factor"><i class="fas fa-sliders-h"></i> Correction Factor (mg/dL per unit)</label>
                    <input type="number" id="correction-factor" placeholder="Enter correction factor" min="1" value="50">
                </div>
                
                <div class="input-group">
                    <label for="time"><i class="fas fa-clock"></i> Time of Day</label>
                    <select id="time">
                        <option value="">Select Time</option>
                        <option value="breakfast">Breakfast</option>
                        <option value="lunch">Lunch</option>
                        <option value="dinner">Dinner</option>
                        <option value="snack">Snack</option>
                    </select>
                </div>
            </div>
            
            <div class="button-group">
                <button id="calculate-btn"><i class="fas fa-calculator"></i> Calculate Insulin Dose</button>
                <button id="reset-btn" class="reset-btn"><i class="fas fa-redo"></i> Reset</button>
                <button id="export-btn" class="export-btn"><i class="fas fa-file-export"></i> Export Results</button>
            </div>

            <div class="result-grid">
                <div class="result-card carb-card">
                    <h3><i class="fas fa-bread-slice"></i> Carb Insulin</h3>
                    <div class="result-value" id="carb-insulin">-- units</div>
                    <div class="result-status normal">Based on carbs</div>
                </div>
                
                <div class="result-card bg-card">
                    <h3><i class="fas fa-heartbeat"></i> Correction Insulin</h3>
                    <div class="result-value" id="correction-insulin">-- units</div>
                    <div class="result-status normal">Based on glucose</div>
                </div>
                
                <div class="result-card total-card">
                    <h3><i class="fas fa-syringe"></i> Total Insulin</h3>
                    <div class="result-value" id="total-insulin">-- units</div>
                    <div class="result-status normal">Carb + Correction</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Insulin Dose Breakdown</h3>
                <div class="chart-bars">
                    <div class="chart-bar carb-bar" id="carb-bar" style="height: 0px;">
                        <div class="chart-value" id="carb-bar-value">0</div>
                        <div class="chart-label">Carb</div>
                    </div>
                    <div class="chart-bar bg-bar" id="bg-bar" style="height: 0px;">
                        <div class="chart-value" id="bg-bar-value">0</div>
                        <div class="chart-label">Correction</div>
                    </div>
                    <div class="chart-bar" id="total-bar" style="height: 0px;">
                        <div class="chart-value" id="total-bar-value">0</div>
                        <div class="chart-label">Total</div>
                    </div>
                </div>
            </div>

            <div class="formula-explanation">
                <h3><i class="fas fa-calculator"></i> Calculation Formula</h3>
                <ul class="formula-steps">
                    <li><strong>Carb Insulin:</strong> Carbs (g) รท Insulin-to-Carb Ratio</li>
                    <li><strong>Correction Insulin:</strong> (Current Glucose - Target Glucose) รท Correction Factor</li>
                    <li><strong>Total Insulin:</strong> Carb Insulin + Correction Insulin</li>
                    <li><em>Note: Correction insulin is only calculated when current glucose is above target</em></li>
                </ul>
            </div>

            <div id="risk-indicator" class="risk-indicator" style="display: none;">
                <i class="fas fa-exclamation-triangle risk-icon"></i>
                <div class="risk-text" id="risk-text">Your insulin dose recommendation will be calculated based on your inputs</div>
            </div>

            <div class="recommendations">
                <h3><i class="fas fa-lightbulb"></i> Important Recommendations</h3>
                <ul class="recommendation-list" id="recommendations-list">
                    <li>Always consult with your healthcare provider before adjusting insulin doses</li>
                    <li>Verify calculations with your diabetes care team</li>
                    <li>Consider timing of insulin administration based on meal type</li>
                </ul>
            </div>

            <div class="data-actions">
                <button id="save-btn"><i class="fas fa-save"></i> Save Current Calculation</button>
                <button id="clear-btn" class="clear-btn"><i class="fas fa-trash-alt"></i> Clear All Data</button>
            </div>

            <div class="health-tip">
                <h3><i class="fas fa-lightbulb"></i> Health Tip</h3>
                <p>Always double-check your insulin calculations and consult with your healthcare provider before administering any insulin dose. Factors like exercise, stress, illness, and timing can affect your insulin needs. Keep a log of your doses and glucose readings to identify patterns.</p>
            </div>
        </div>

        <div class="tab-content" id="history-tab">
            <h2 style="text-align: center; margin-bottom: 20px; color: #2c3e50;"><i class="fas fa-history"></i> Calculation History</h2>
            <div class="history-list" id="history-list">
                <div class="no-history">No history available. Save your calculations to see them here.</div>
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button id="export-history" class="export-btn"><i class="fas fa-file-export"></i> Export History</button>
                <button id="clear-history" class="clear-btn"><i class="fas fa-trash-alt"></i> Clear History</button>
            </div>
        </div>

        <div class="tab-content" id="progress-tab">
            <h2 style="text-align: center; margin-bottom: 20px; color: #2c3e50;"><i class="fas fa-chart-line"></i> Progress Tracker</h2>
            <div class="progress-tracker">
                <h3 class="progress-title"><i class="fas fa-tasks"></i> Your Insulin Usage Patterns</h3>
                <div class="progress-charts" id="progress-charts">
                    <div class="no-history">No progress data available. Save your calculations to track progress.</div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="resources-tab">
            <h2 style="text-align: center; margin-bottom: 20px; color: #2c3e50;"><i class="fas fa-book"></i> Diabetes Resources</h2>
            
            <div class="interpretation">
                <h3><i class="fas fa-info-circle"></i> Understanding Insulin Dosing</h3>
                <p>Insulin dosing involves calculating both bolus insulin for meals (carb coverage) and correction insulin for high blood glucose levels. The calculations are based on your personal insulin-to-carb ratio and correction factor, which should be determined by your healthcare provider.</p>
                <p>Your insulin-to-carb ratio tells you how many grams of carbohydrate are covered by one unit of insulin. Your correction factor tells you how much one unit of insulin will lower your blood glucose.</p>
            </div>
            
            <div class="health-tip">
                <h3><i class="fas fa-utensils"></i> Meal Planning Tips</h3>
                <ul>
                    <li>Count carbohydrates accurately using measuring tools</li>
                    <li>Choose consistent carb amounts at meals when possible</li>
                    <li>Include fiber-rich foods which may affect glucose absorption</li>
                    <li>Account for protein and fat which can impact glucose later</li>
                    <li>Time rapid-acting insulin 15-20 minutes before eating</li>
                </ul>
            </div>
            
            <div class="recommendations">
                <h3><i class="fas fa-running"></i> Exercise Considerations</h3>
                <ul class="recommendation-list">
                    <li>Check glucose before, during, and after exercise</li>
                    <li>Adjust insulin doses or add snacks as needed</li>
                    <li>Stay hydrated during physical activity</li>
                    <li>Be aware that exercise can increase insulin sensitivity for hours</li>
                    <li>Keep fast-acting carbohydrates available during exercise</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // DOM Elements
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const carbsInput = document.getElementById('carbs');
        const currentBgInput = document.getElementById('current-bg');
        const targetBgInput = document.getElementById('target-bg');
        const carbRatioInput = document.getElementById('carb-ratio');
        const correctionFactorInput = document.getElementById('correction-factor');
        const timeSelect = document.getElementById('time');
        const calculateBtn = document.getElementById('calculate-btn');
        const resetBtn = document.getElementById('reset-btn');
        const exportBtn = document.getElementById('export-btn');
        const carbInsulinResult = document.getElementById('carb-insulin');
        const correctionInsulinResult = document.getElementById('correction-insulin');
        const totalInsulinResult = document.getElementById('total-insulin');
        const saveBtn = document.getElementById('save-btn');
        const clearBtn = document.getElementById('clear-btn');
        const exportHistoryBtn = document.getElementById('export-history');
        const clearHistoryBtn = document.getElementById('clear-history');
        const historyList = document.getElementById('history-list');
        const riskIndicator = document.getElementById('risk-indicator');
        const riskText = document.getElementById('risk-text');
        const recommendationsList = document.getElementById('recommendations-list');
        const notification = document.getElementById('notification');
        const progressCharts = document.getElementById('progress-charts');

        // Chart bars
        const carbBar = document.getElementById('carb-bar');
        const bgBar = document.getElementById('bg-bar');
        const totalBar = document.getElementById('total-bar');
        const carbBarValue = document.getElementById('carb-bar-value');
        const bgBarValue = document.getElementById('bg-bar-value');
        const totalBarValue = document.getElementById('total-bar-value');

        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show active content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabName}-tab`) {
                        content.classList.add('active');
                        if (tabName === 'history') {
                            loadHistory();
                        } else if (tabName === 'progress') {
                            loadProgressData();
                        }
                    }
                });
            });
        });

        // Load saved data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSavedData();
            updateChartBars(0, 0, 0);
        });

        // Calculate insulin dose
        calculateBtn.addEventListener('click', () => {
            const carbs = parseFloat(carbsInput.value);
            const currentBg = parseFloat(currentBgInput.value);
            const targetBg = parseFloat(targetBgInput.value);
            const carbRatio = parseFloat(carbRatioInput.value);
            const correctionFactor = parseFloat(correctionFactorInput.value);

            if (isNaN(carbs) || isNaN(currentBg) || isNaN(targetBg) || isNaN(carbRatio) || isNaN(correctionFactor)) {
                showNotification('Please enter all required values', 'error');
                return;
            }

            if (carbRatio <= 0 || correctionFactor <= 0) {
                showNotification('Insulin ratios must be greater than zero', 'error');
                return;
            }

            // Calculate insulin doses
            const carbInsulin = carbs / carbRatio;
            const bgDifference = currentBg - targetBg;
            const correctionInsulin = bgDifference > 0 ? bgDifference / correctionFactor : 0;
            const totalInsulin = carbInsulin + correctionInsulin;

            // Update results
            carbInsulinResult.textContent = `${carbInsulin.toFixed(1)} units`;
            correctionInsulinResult.textContent = `${correctionInsulin.toFixed(1)} units`;
            totalInsulinResult.textContent = `${totalInsulin.toFixed(1)} units`;

            // Update chart
            updateChartBars(carbInsulin, correctionInsulin, totalInsulin);
            
            // Generate recommendations
            generateRecommendations(totalInsulin, currentBg, targetBg);
            
            showNotification('Insulin dose calculated successfully!', 'success');
        });

        // Reset form
        resetBtn.addEventListener('click', () => {
            carbsInput.value = '';
            currentBgInput.value = '';
            targetBgInput.value = '100';
            carbRatioInput.value = '10';
            correctionFactorInput.value = '50';
            timeSelect.value = '';
            carbInsulinResult.textContent = '-- units';
            correctionInsulinResult.textContent = '-- units';
            totalInsulinResult.textContent = '-- units';
            updateChartBars(0, 0, 0);
            riskIndicator.style.display = 'none';
            recommendationsList.innerHTML = `
                <li>Always consult with your healthcare provider before adjusting insulin doses</li>
                <li>Verify calculations with your diabetes care team</li>
                <li>Consider timing of insulin administration based on meal type</li>
            `;
            showNotification('Form reset successfully!', 'info');
        });

        // Save data to localStorage
        saveBtn.addEventListener('click', () => {
            const carbs = parseFloat(carbsInput.value);
            const currentBg = parseFloat(currentBgInput.value);
            const targetBg = parseFloat(targetBgInput.value);
            const carbRatio = parseFloat(carbRatioInput.value);
            const correctionFactor = parseFloat(correctionFactorInput.value);
            const time = timeSelect.value;

            if (isNaN(carbs) || isNaN(currentBg) || isNaN(targetBg) || isNaN(carbRatio) || isNaN(correctionFactor)) {
                showNotification('Please calculate dose first', 'error');
                return;
            }

            const carbInsulin = carbs / carbRatio;
            const bgDifference = currentBg - targetBg;
            const correctionInsulin = bgDifference > 0 ? bgDifference / correctionFactor : 0;
            const totalInsulin = carbInsulin + correctionInsulin;

            const data = {
                carbs: carbs,
                currentBg: currentBg,
                targetBg: targetBg,
                carbRatio: carbRatio,
                correctionFactor: correctionFactor,
                time: time,
                carbInsulin: carbInsulin,
                correctionInsulin: correctionInsulin,
                totalInsulin: totalInsulin,
                timestamp: new Date().toLocaleString()
            };
            
            // Get existing history
            let history = JSON.parse(localStorage.getItem('insulinHistory')) || [];
            history.push(data);
            
            // Keep only last 50 entries
            if (history.length > 50) {
                history = history.slice(-50);
            }
            
            localStorage.setItem('insulinHistory', JSON.stringify(history));
            showNotification('Calculation saved successfully!', 'success');
        });

        // Clear all data from localStorage
        clearBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all saved data? This cannot be undone.')) {
                localStorage.removeItem('insulinData');
                localStorage.removeItem('insulinHistory');
                showNotification('All data cleared successfully!', 'info');
            }
        });

        // Export current results
        exportBtn.addEventListener('click', () => {
            const carbs = parseFloat(carbsInput.value);
            const currentBg = parseFloat(currentBgInput.value);
            const targetBg = parseFloat(targetBgInput.value);
            const carbRatio = parseFloat(carbRatioInput.value);
            const correctionFactor = parseFloat(correctionFactorInput.value);

            if (isNaN(carbs) || isNaN(currentBg) || isNaN(targetBg) || isNaN(carbRatio) || isNaN(correctionFactor)) {
                showNotification('Please calculate dose first', 'error');
                return;
            }

            const carbInsulin = carbs / carbRatio;
            const bgDifference = currentBg - targetBg;
            const correctionInsulin = bgDifference > 0 ? bgDifference / correctionFactor : 0;
            const totalInsulin = carbInsulin + correctionInsulin;

            const csvContent = `Insulin Dose Calculation\nDate: ${new Date().toLocaleString()}\nCarbs: ${carbs}g\nCurrent Glucose: ${currentBg} mg/dL\nTarget Glucose: ${targetBg} mg/dL\nCarb Insulin: ${carbInsulin.toFixed(1)} units\nCorrection Insulin: ${correctionInsulin.toFixed(1)} units\nTotal Insulin: ${totalInsulin.toFixed(1)} units`;
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `insulin_dose_${new Date().toISOString().slice(0,10)}.txt`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showNotification('Results exported successfully!', 'success');
        });

        // Export history
        exportHistoryBtn.addEventListener('click', () => {
            const history = JSON.parse(localStorage.getItem('insulinHistory')) || [];
            
            if (history.length === 0) {
                showNotification('No history to export', 'error');
                return;
            }
            
            let csvContent = 'Date,Carbs,Current BG,Target BG,Carb Ratio,Correction Factor,Carb Insulin,Correction Insulin,Total Insulin,Time\n';
            history.forEach(entry => {
                csvContent += `"${entry.timestamp}",${entry.carbs},${entry.currentBg},${entry.targetBg},${entry.carbRatio},${entry.correctionFactor},${entry.carbInsulin.toFixed(1)},${entry.correctionInsulin.toFixed(1)},${entry.totalInsulin.toFixed(1)},"${entry.time || ''}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `insulin_history_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showNotification('History exported successfully!', 'success');
        });

        // Clear history
        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all history? This cannot be undone.')) {
                localStorage.removeItem('insulinHistory');
                loadHistory();
                showNotification('History cleared successfully!', 'info');
            }
        });

        // Load saved data from localStorage
        function loadSavedData() {
            const savedData = localStorage.getItem('insulinData');
            if (savedData) {
                const data = JSON.parse(savedData);
                carbsInput.value = data.carbs || '';
                currentBgInput.value = data.currentBg || '';
                targetBgInput.value = data.targetBg || '100';
                carbRatioInput.value = data.carbRatio || '10';
                correctionFactorInput.value = data.correctionFactor || '50';
                timeSelect.value = data.time || '';
            }
        }

        // Update chart bars with animation
        function updateChartBars(carbInsulin, correctionInsulin, totalInsulin) {
            // Normalize values for chart display (max 20 units for visualization)
            const maxValue = 20;
            const carbHeight = Math.min(100, (carbInsulin / maxValue) * 100);
            const bgHeight = Math.min(100, (correctionInsulin / maxValue) * 100);
            const totalHeight = Math.min(100, (totalInsulin / maxValue) * 100);
            
            carbBar.style.height = `${carbHeight}%`;
            bgBar.style.height = `${bgHeight}%`;
            totalBar.style.height = `${totalHeight}%`;
            
            carbBarValue.textContent = carbInsulin.toFixed(1);
            bgBarValue.textContent = correctionInsulin.toFixed(1);
            totalBarValue.textContent = totalInsulin.toFixed(1);
        }

        // Generate personalized recommendations
        function generateRecommendations(totalInsulin, currentBg, targetBg) {
            let recommendations = [];
            
            if (totalInsulin > 15) {
                recommendations.push('This is a large insulin dose. Double-check your calculations and consult your healthcare provider.');
                recommendations.push('Consider splitting the dose if appropriate for your insulin type.');
            } else if (totalInsulin > 10) {
                recommendations.push('This is a moderate insulin dose. Ensure proper injection technique.');
            } else if (totalInsulin > 0) {
                recommendations.push('Standard insulin dose. Follow your usual administration routine.');
            }
            
            if (currentBg > targetBg + 50) {
                recommendations.push('Your glucose is significantly elevated. Monitor closely after dosing.');
                recommendations.push('Consider ketone testing if you have type 1 diabetes.');
            } else if (currentBg < targetBg - 20) {
                recommendations.push('Your glucose is below target. Consider if correction insulin is needed.');
            }
            
            if (recommendations.length === 0) {
                recommendations.push('Dose calculation appears standard. Always verify with your healthcare provider.');
            }
            
            recommendationsList.innerHTML = recommendations.map(rec => `<li>${rec}</li>`).join('');
        }

        // Load history into tab
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('insulinHistory')) || [];
            
            if (history.length === 0) {
                historyList.innerHTML = '<div class="no-history">No history available. Save your calculations to see them here.</div>';
                return;
            }
            
            let historyHTML = '';
            history.slice().reverse().forEach((entry, index) => {
                const originalIndex = history.length - 1 - index;
                historyHTML += `
                    <div class="history-item">
                        <div class="history-item-header">
                            <span>${entry.timestamp}</span>
                            <button class="delete-history" data-index="${originalIndex}" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                        </div>
                        <div class="history-item-values">
                            <div class="history-value">
                                <div class="history-value-label">Carbs</div>
                                <div class="history-value-data">${entry.carbs}g</div>
                            </div>
                            <div class="history-value">
                                <div class="history-value-label">Current</div>
                                <div class="history-value-data">${entry.currentBg}</div>
                            </div>
                            <div class="history-value">
                                <div class="history-value-label">Target</div>
                                <div class="history-value-data">${entry.targetBg}</div>
                            </div>
                            <div class="history-value">
                                <div class="history-value-label">Total</div>
                                <div class="history-value-data">${entry.totalInsulin.toFixed(1)}u</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            Time: ${entry.time || 'N/A'}
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = historyHTML;
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-history').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteHistoryEntry(index);
                });
            });
        }

        // Delete a history entry
        function deleteHistoryEntry(index) {
            let history = JSON.parse(localStorage.getItem('insulinHistory')) || [];
            history.splice(index, 1);
            localStorage.setItem('insulinHistory', JSON.stringify(history));
            loadHistory();
            showNotification('History entry deleted!', 'info');
        }

        // Load progress data
        function loadProgressData() {
            const history = JSON.parse(localStorage.getItem('insulinHistory')) || [];
            
            if (history.length === 0) {
                progressCharts.innerHTML = '<div class="no-history">No progress data available. Save your calculations to track progress.</div>';
                return;
            }
            
            // Calculate averages
            const avgTotal = history.reduce((sum, entry) => sum + entry.totalInsulin, 0) / history.length;
            const avgCarbs = history.reduce((sum, entry) => sum + entry.carbs, 0) / history.length;
            const avgBg = history.reduce((sum, entry) => sum + entry.currentBg, 0) / history.length;
            
            // Create progress charts
            let chartsHTML = `
                <div class="progress-chart">
                    <h4>Average Total Insulin</h4>
                    <div class="progress-line">
                        <div class="progress-fill" style="width: ${Math.min(100, (avgTotal / 20) * 100)}%"></div>
                        <div class="progress-target" style="left: ${(10 / 20) * 100}%"></div>
                    </div>
                    <div class="progress-info">
                        <span>Average: ${avgTotal.toFixed(1)} units</span>
                        <span>Target: Varies by person</span>
                    </div>
                </div>
                
                <div class="progress-chart">
                    <h4>Average Carbohydrates</h4>
                    <div class="progress-line">
                        <div class="progress-fill" style="width: ${Math.min(100, (avgCarbs / 100) * 100)}%"></div>
                        <div class="progress-target" style="left: ${(50 / 100) * 100}%"></div>
                    </div>
                    <div class="progress-info">
                        <span>Average: ${avgCarbs.toFixed(1)}g</span>
                        <span>Target: Varies by meal</span>
                    </div>
                </div>
                
                <div class="progress-chart">
                    <h4>Average Glucose</h4>
                    <div class="progress-line">
                        <div class="progress-fill" style="width: ${Math.min(100, (avgBg / 200) * 100)}%"></div>
                        <div class="progress-target" style="left: ${(100 / 200) * 100}%"></div>
                    </div>
                    <div class="progress-info">
                        <span>Average: ${avgBg.toFixed(1)} mg/dL</span>
                        <span>Target: ${history[0]?.targetBg || 100} mg/dL</span>
                    </div>
                </div>
            `;
            
            progressCharts.innerHTML = chartsHTML;
        }

        // Show notification
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>