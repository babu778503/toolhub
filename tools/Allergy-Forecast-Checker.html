<!DOCTYPE html>
<!-- Category: Health -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allergy Forecast Checker</title>
    <!-- Favicon using a data URI -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤§</text></svg>">
    <style>
        :root {
            --color-primary: #1abc9c; /* Turquoise */
            --color-dark: #2c3e50;
            --color-light-bg: #f4f7f6;
            --color-card-bg: #ffffff;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --radius: 8px;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            
            --level-low: #27ae60;
            --level-moderate: #f1c40f;
            --level-high: #e67e22;
            --level-very-high: #c0392b;
        }

        body {
            font-family: var(--font-family); background-color: var(--color-light-bg);
            color: var(--color-dark); margin: 0; padding: 20px;
        }

        .container { max-width: 800px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 25px; }
        header h1 { margin: 0; }
        header p { color: #7f8c8d; }

        .panel { background: var(--color-card-bg); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 25px; }
        .panel h2 { color: var(--color-primary); margin-top: 0; }
        
        .location-form { display: flex; gap: 15px; flex-wrap: wrap; }
        .location-form input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: var(--radius); }
        .location-form button { padding: 10px 15px; border: none; border-radius: var(--radius); cursor: pointer; background-color: var(--color-primary); color: white; font-weight: bold; }
        
        .triggers-form { display: flex; gap: 20px; flex-wrap: wrap; }
        .triggers-form label { display: flex; align-items: center; gap: 8px; cursor: pointer; }

        #forecast-panel { text-align: center; }
        #forecast-results { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .forecast-card {
            padding: 15px; border-radius: var(--radius); border: 2px solid;
            transition: transform 0.2s;
        }
        .forecast-card.highlight { transform: scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .forecast-card h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .forecast-card .value { font-size: 2rem; font-weight: bold; }
        .forecast-card .level { font-size: 0.9rem; font-weight: bold; }

        .level-low { border-color: var(--level-low); color: var(--level-low); }
        .level-moderate { border-color: var(--level-moderate); color: var(--level-moderate); }
        .level-high { border-color: var(--level-high); color: var(--level-high); }
        .level-very-high { border-color: var(--level-very-high); color: var(--level-very-high); }

        #status-message { font-size: 1.1rem; color: #7f8c8d; }
        #clear-data-btn { display: block; margin: 30px auto 0; background: none; border: none; color: #c0392b; cursor: pointer; text-decoration: underline; }
        .disclaimer { text-align: center; margin-top: 15px; font-size: 0.8rem; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Allergy Forecast Checker</h1>
            <p>Get real-time pollen levels for your area. Your location and triggers are saved privately on your device.</p>
        </header>

        <section class="panel">
            <h2>Your Location</h2>
            <form class="location-form" id="location-form">
                <input type="text" id="city-input" placeholder="Enter City Name and press Enter">
                <button type="button" id="geolocate-btn">Use My Current Location</button>
            </form>
        </section>

        <section class="panel">
            <h2>My Allergy Triggers</h2>
            <div class="triggers-form" id="triggers-form">
                <label><input type="checkbox" data-trigger="tree"> Tree Pollen</label>
                <label><input type="checkbox" data-trigger="grass"> Grass Pollen</label>
                <label><input type="checkbox" data-trigger="weed"> Weed Pollen</label>
            </div>
        </section>

        <section class="panel" id="forecast-panel">
            <h2 id="forecast-location">Forecast</h2>
            <div id="status-message">Set your location to see the forecast.</div>
            <div id="forecast-results"></div>
        </section>

        <button id="clear-data-btn">Clear Saved Data</button>
        <p class="disclaimer">Forecast data provided by Open-Meteo. This tool is for informational purposes only and is not medical advice.</p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const STORAGE_KEYS = { LOCATION: 'allergyCheckerLocation', TRIGGERS: 'allergyCheckerTriggers' };

        // --- DOM Elements ---
        const cityInput = document.getElementById('city-input');
        const locationForm = document.getElementById('location-form');
        const geolocateBtn = document.getElementById('geolocate-btn');
        const triggersForm = document.getElementById('triggers-form');
        const forecastLocationEl = document.getElementById('forecast-location');
        const statusMessage = document.getElementById('status-message');
        const forecastResults = document.getElementById('forecast-results');
        
        // --- Core Application Logic ---
        function getRiskLevel(value) {
            if (value < 1) return { text: 'Low', className: 'level-low' };
            if (value < 20) return { text: 'Moderate', className: 'level-moderate' };
            if (value < 100) return { text: 'High', className: 'level-high' };
            return { text: 'Very High', className: 'level-very-high' };
        }

        async function getForecast(lat, lon) {
            statusMessage.textContent = 'Loading forecast...';
            forecastResults.innerHTML = '';
            
            const API_URL = `https://air-quality-api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=alder_pollen,birch_pollen,grass_pollen,mugwort_pollen,olive_pollen,ragweed_pollen`;
            
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Network response was not ok.');
                const data = await response.json();
                
                statusMessage.textContent = '';
                displayForecast(data);

            } catch (error) {
                statusMessage.textContent = 'Could not fetch forecast. Please try again later.';
                console.error("Fetch error:", error);
            }
        }
        
        function displayForecast(data) {
            const hourly = data.hourly;
            const now = new Date();
            const currentHourIndex = hourly.time.findIndex(timeStr => new Date(timeStr) >= now);
            if (currentHourIndex === -1) {
                statusMessage.textContent = "Forecast data is for the past. Please check back later.";
                return;
            }

            const getPollenValue = (pollenTypes) => {
                let total = 0;
                pollenTypes.forEach(type => {
                    if (hourly[type] && hourly[type][currentHourIndex] != null) {
                        total += hourly[type][currentHourIndex];
                    }
                });
                return total;
            };

            const pollenData = {
                tree: getPollenValue(['alder_pollen', 'birch_pollen', 'olive_pollen']),
                grass: getPollenValue(['grass_pollen']),
                weed: getPollenValue(['mugwort_pollen', 'ragweed_pollen'])
            };
            
            const savedTriggers = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRIGGERS) || '[]');
            forecastResults.innerHTML = '';

            for (const [type, value] of Object.entries(pollenData)) {
                const risk = getRiskLevel(value);
                const card = document.createElement('div');
                card.className = `forecast-card ${risk.className}`;
                if (savedTriggers.includes(type)) {
                    card.classList.add('highlight');
                }
                card.innerHTML = `
                    <h3>${type.charAt(0).toUpperCase() + type.slice(1)} Pollen</h3>
                    <div class="value">${value.toFixed(0)}</div>
                    <div class="level">${risk.text}</div>
                `;
                forecastResults.appendChild(card);
            }
        }

        async function handleCitySearch(e) {
            e.preventDefault();
            const city = cityInput.value.trim();
            if (!city) return;
            
            statusMessage.textContent = `Searching for ${city}...`;
            try {
                const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1`);
                const geoData = await geoResponse.json();
                if (!geoData.results || geoData.results.length === 0) {
                    throw new Error('City not found.');
                }
                const { latitude, longitude, name } = geoData.results[0];
                const location = { lat: latitude, lon: longitude, name: name };
                
                saveData(STORAGE_KEYS.LOCATION, location);
                forecastLocationEl.textContent = `Forecast for ${name}`;
                getForecast(latitude, longitude);

            } catch (error) {
                statusMessage.textContent = `Could not find "${city}". Please try a different name.`;
            }
        }

        function handleGeoLocate() {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }
            statusMessage.textContent = 'Getting your location...';
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    const location = { lat: latitude, lon: longitude, name: "Current Location" };
                    saveData(STORAGE_KEYS.LOCATION, location);
                    forecastLocationEl.textContent = `Forecast for Current Location`;
                    getForecast(latitude, longitude);
                },
                () => { statusMessage.textContent = 'Unable to retrieve your location.'; }
            );
        }

        // --- Data Persistence & Settings ---
        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function loadData() {
            // Load and apply triggers
            const savedTriggers = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRIGGERS) || '[]');
            triggersForm.querySelectorAll('input').forEach(checkbox => {
                if (savedTriggers.includes(checkbox.dataset.trigger)) {
                    checkbox.checked = true;
                }
            });

            // Load location and fetch forecast
            const savedLocation = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOCATION));
            if (savedLocation) {
                forecastLocationEl.textContent = `Forecast for ${savedLocation.name}`;
                getForecast(savedLocation.lat, savedLocation.lon);
            }
        }
        
        function handleTriggersChange() {
            const selectedTriggers = Array.from(triggersForm.querySelectorAll('input:checked')).map(cb => cb.dataset.trigger);
            saveData(STORAGE_KEYS.TRIGGERS, selectedTriggers);
            // Re-render highlights
            const savedLocation = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOCATION));
            if (savedLocation) getForecast(savedLocation.lat, savedLocation.lon);
        }

        // --- Event Listeners ---
        locationForm.addEventListener('submit', handleCitySearch);
        geolocateBtn.addEventListener('click', handleGeoLocate);
        triggersForm.addEventListener('change', handleTriggersChange);
        document.getElementById('clear-data-btn').addEventListener('click', () => {
            if (confirm("Are you sure you want to clear all saved data?")) {
                localStorage.removeItem(STORAGE_KEYS.LOCATION);
                localStorage.removeItem(STORAGE_KEYS.TRIGGERS);
                window.location.reload();
            }
        });
        
        // --- Initial Load ---
        loadData();
    });
    </script>
</body>
</html>